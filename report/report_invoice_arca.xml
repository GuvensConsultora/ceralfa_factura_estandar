<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!--
        CRÍTICO: Registrar nuestro template en la cadena de dispatch de account.report_invoice.
        Por qué: En Odoo 19, el wrapper usa t-if/t-elif para despachar a cada template por nombre exacto.
        Sin este bloque, _get_name_invoice_report() devuelve nuestro ID pero ningún t-if lo matchea → página en blanco.
    -->
    <template id="report_invoice_inherit" inherit_id="account.report_invoice">
        <xpath expr='//t[@t-call="l10n_ar.report_invoice_document"]' position="after">
            <t t-elif="o._get_name_invoice_report() == 'ceralfa_factura_estandar.report_invoice_arca_document'"
               t-call="ceralfa_factura_estandar.report_invoice_arca_document"
               t-lang="lang"/>
        </xpath>
    </template>

    <!-- Documento individual de factura ARCA -->
    <template id="report_invoice_arca_document">
        <!--
            Template standalone con formato ARCA limpio.
            - Tablas HTML (no flexbox) → compatible wkhtmltopdf
            - display_type == 'product' → Odoo 19 (ya no es False)
            - Sin hasattr() → no disponible en sandbox QWeb
            - Usa sub-template account.document_tax_totals → estructura Odoo 19
        -->
        <t t-call="web.external_layout">
            <t t-set="o" t-value="o.with_context(lang=lang)"/>

            <!-- Variables auxiliares -->
            <t t-set="letra" t-value="o.l10n_latam_document_type_id.l10n_ar_letter or ''"/>
            <t t-set="cod_afip" t-value="o.l10n_latam_document_type_id.code or ''"/>
            <t t-set="is_multimoneda" t-value="o.currency_id != o.company_currency_id"/>

            <!-- Tipo de documento: usa report_name de l10n_latam (mismo patrón que l10n_ar estándar) -->
            <t t-set="tipo_doc" t-value="o.l10n_latam_document_type_id.report_name or 'Factura'"/>

            <div class="page" style="font-family: Arial, Helvetica, sans-serif; font-size: 12px;">

                <!-- ==================== HEADER ==================== -->
                <table style="width: 100%; margin-bottom: 10px;">
                    <tr>
                        <!-- Izquierda: Logo + datos empresa -->
                        <td style="width: 38%; vertical-align: top;">
                            <img t-if="o.company_id.logo"
                                 t-att-src="image_data_uri(o.company_id.logo)"
                                 style="max-height: 65px; margin-bottom: 8px;"
                                 alt="Logo"/>
                            <div style="font-size: 10px; line-height: 1.4;">
                                <strong t-field="o.company_id.partner_id.name"/>
                                <br/>
                                <span t-field="o.company_id.partner_id"
                                      t-options='{"widget": "contact", "fields": ["address"], "no_marker": true}'/>
                                <t t-if="o.company_id.phone">
                                    Tel: <span t-field="o.company_id.phone"/><br/>
                                </t>
                                <t t-if="o.company_id.website">
                                    <span t-field="o.company_id.website"/><br/>
                                </t>
                                <t t-if="o.company_id.email">
                                    <span t-field="o.company_id.email"/>
                                </t>
                            </div>
                        </td>

                        <!-- Centro: Letra grande + código AFIP -->
                        <td style="width: 14%; text-align: center; vertical-align: top;">
                            <div style="border: 2px solid #000; display: inline-block; padding: 5px 18px; margin-top: 5px;">
                                <span style="font-size: 42px; font-weight: bold;" t-esc="letra"/>
                            </div>
                            <div t-if="cod_afip" style="font-size: 9px; margin-top: 2px;">
                                Cod. <span t-esc="'%02d' % int(cod_afip) if cod_afip else ''"/>
                            </div>
                        </td>

                        <!-- Derecha: Tipo doc + datos factura -->
                        <td style="width: 38%; text-align: right; vertical-align: top;">
                            <div style="font-size: 18px; font-weight: bold; margin-bottom: 6px;"
                                 t-att-style="'color: %s;' % (o.company_id.primary_color or '#000')">
                                <span t-esc="tipo_doc"/>
                            </div>
                            <div style="font-size: 10px; line-height: 1.6;">
                                <span t-att-style="'color: %s;' % (o.company_id.secondary_color or '#666')">Nro: </span>
                                <span t-field="o.l10n_latam_document_number"/><br/>
                                <span t-att-style="'color: %s;' % (o.company_id.secondary_color or '#666')">Fecha: </span>
                                <span t-field="o.invoice_date"/><br/>
                                <span t-field="o.company_id.l10n_ar_afip_responsibility_type_id"/>
                                <span t-att-style="'color: %s;' % (o.company_id.secondary_color or '#666')"> - CUIT: </span>
                                <span t-field="o.company_id.partner_id.l10n_ar_formatted_vat"/><br/>
                                <span t-att-style="'color: %s;' % (o.company_id.secondary_color or '#666')">IIBB: </span>
                                <span t-esc="o.company_id.l10n_ar_gross_income_number or 'Exento'"/>
                                <span t-att-style="'color: %s;' % (o.company_id.secondary_color or '#666')"> - Inicio Act.: </span>
                                <span t-field="o.company_id.l10n_ar_afip_start_date"/>
                            </div>
                        </td>
                    </tr>
                </table>

                <hr style="border: 1px solid #000; margin: 5px 0 10px 0;"/>

                <!-- ==================== DATOS CLIENTE + DETALLES ==================== -->
                <table style="width: 100%; margin-bottom: 15px;">
                    <tr>
                        <!-- Izquierda: Datos del cliente -->
                        <td style="width: 48%; border: 1px solid #ccc; padding: 8px; font-size: 10px; line-height: 1.5; vertical-align: top;">
                            <strong>Cliente:</strong>
                            <span t-field="o.partner_id.commercial_partner_id.name"/><br/>
                            <span t-field="o.partner_id"
                                  t-options='{"widget": "contact", "fields": ["address"], "no_marker": true}'/><br/>
                            <strong>Cond. IVA:</strong>
                            <span t-field="o.partner_id.l10n_ar_afip_responsibility_type_id"/><br/>
                            <t t-if="o.partner_id.vat and o.partner_id.l10n_latam_identification_type_id">
                                <strong t-field="o.partner_id.l10n_latam_identification_type_id"/>:
                                <span t-esc="o.partner_id.l10n_ar_formatted_vat or o.partner_id.vat"/>
                            </t>
                        </td>

                        <td style="width: 4%;"/>

                        <!-- Derecha: Detalles de la factura -->
                        <td style="width: 48%; border: 1px solid #ccc; padding: 8px; font-size: 10px; line-height: 1.5; vertical-align: top;">
                            <t t-if="o.invoice_date_due">
                                <strong>Fecha Vencimiento:</strong>
                                <span t-field="o.invoice_date_due"/><br/>
                            </t>
                            <t t-if="o.invoice_payment_term_id">
                                <strong>Plazos de Pago:</strong>
                                <span t-field="o.invoice_payment_term_id.name"/><br/>
                            </t>
                            <t t-if="o.invoice_origin">
                                <strong>Origen:</strong>
                                <span t-field="o.invoice_origin"/><br/>
                            </t>
                            <t t-if="o.ref">
                                <strong>Referencia:</strong>
                                <span t-field="o.ref"/>
                            </t>
                        </td>
                    </tr>
                </table>

                <!-- ==================== TABLA DE LÍNEAS ==================== -->
                <!-- Por qué: Mismo patrón que l10n_ar estándar con _l10n_ar_prices_and_taxes() -->
                <t t-set="display_discount" t-value="any(l.discount for l in o.invoice_line_ids)"/>
                <table style="width: 100%; border-collapse: collapse; font-size: 10px; margin-bottom: 10px;">
                    <thead>
                        <tr style="border-bottom: 2px solid #000;">
                            <th style="text-align: left; padding: 5px;">Descripción</th>
                            <th style="text-align: right; padding: 5px;">Cantidad</th>
                            <th style="text-align: right; padding: 5px;">Precio Unit.</th>
                            <th t-if="display_discount" style="text-align: right; padding: 5px;">Dto.%</th>
                            <th style="text-align: center; padding: 5px;">% IVA</th>
                            <th style="text-align: right; padding: 5px;">Importe</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="o.invoice_line_ids" t-as="line">
                            <!-- Odoo 19: display_type='product' para líneas de producto -->
                            <t t-if="line.display_type == 'product'">
                                <t t-set="l10n_ar_values" t-value="line._l10n_ar_prices_and_taxes()"/>
                                <tr style="border-bottom: 1px solid #ddd;">
                                    <td style="padding: 4px 5px;">
                                        <span t-field="line.name" t-options="{'widget': 'text'}"/>
                                    </td>
                                    <td style="text-align: right; padding: 4px 5px; white-space: nowrap;">
                                        <span t-field="line.quantity"/>
                                        <span t-field="line.product_uom_id" groups="uom.group_uom"/>
                                    </td>
                                    <td style="text-align: right; padding: 4px 5px;">
                                        <span t-out="l10n_ar_values['price_unit']"
                                              t-options='{"widget": "float", "decimal_precision": "Product Price"}'/>
                                    </td>
                                    <td t-if="display_discount" style="text-align: right; padding: 4px 5px;">
                                        <span t-field="line.discount"/>
                                    </td>
                                    <td style="text-align: center; padding: 4px 5px;">
                                        <t t-foreach="line.tax_ids" t-as="tax">
                                            <span t-if="tax.tax_group_id.l10n_ar_vat_afip_code" t-esc="tax.tax_label"/>
                                        </t>
                                    </td>
                                    <td style="text-align: right; padding: 4px 5px;">
                                        <span t-out="l10n_ar_values['price_subtotal']"
                                              t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                    </td>
                                </tr>
                            </t>
                            <!-- Secciones -->
                            <t t-if="line.display_type == 'line_section'">
                                <tr>
                                    <td colspan="99" style="padding: 6px 5px; font-weight: bold;">
                                        <span t-field="line.name" t-options="{'widget': 'text'}"/>
                                    </td>
                                </tr>
                            </t>
                            <!-- Notas -->
                            <t t-if="line.display_type == 'line_note'">
                                <tr>
                                    <td colspan="99" style="padding: 3px 5px; font-style: italic;">
                                        <span t-field="line.name" t-options="{'widget': 'text'}"/>
                                    </td>
                                </tr>
                            </t>
                        </t>
                    </tbody>
                </table>

                <!-- ==================== TOTALES ==================== -->
                <!-- Por qué: usa sub-template account.document_tax_totals (estructura Odoo 19 probada) -->
                <table style="width: 100%; margin-bottom: 10px;">
                    <tr>
                        <!-- Izquierda: Moneda y tipo de cambio -->
                        <td style="width: 48%; font-size: 10px; vertical-align: top;">
                            <t t-if="is_multimoneda">
                                <strong>Moneda:</strong>
                                <span t-esc="'%s - %s' % (o.currency_id.name, o.currency_id.currency_unit_label)"/><br/>
                                <strong>Tipo de cambio:</strong>
                                1 <span t-esc="o.currency_id.name"/> =
                                <span t-out="1 / (o.invoice_currency_rate or 1)" t-options='{"widget": "float", "precision": 2}'/>
                                <span t-esc="o.company_currency_id.name"/>
                            </t>
                            <!-- Período de servicio (AFIP concepto 2-4) -->
                            <t t-if="o.l10n_ar_afip_concept in ['2', '3', '4'] and o.l10n_ar_afip_service_start and o.l10n_ar_afip_service_end">
                                <br/><strong>Período facturado: </strong>
                                <span t-field="o.l10n_ar_afip_service_start"/> a <span t-field="o.l10n_ar_afip_service_end"/>
                            </t>
                        </td>

                        <td style="width: 4%;"/>

                        <!-- Derecha: Totales usando sub-template estándar -->
                        <td style="width: 48%; vertical-align: top;">
                            <table class="table table-sm table-borderless mb-0" style="font-size: 10px;">
                                <t t-if="o.tax_totals" t-call="account.document_tax_totals">
                                    <t t-set="tax_totals" t-value="o.tax_totals"/>
                                    <t t-set="currency" t-value="o.currency_id"/>
                                </t>
                            </table>
                        </td>
                    </tr>
                </table>

                <!-- ==================== IMPUESTOS EN MONEDA COMPAÑÍA (multimoneda) ==================== -->
                <t t-if="is_multimoneda and o.tax_totals and o.tax_totals.get('display_in_company_currency')">
                    <div style="width: 48%; float: right; margin-bottom: 10px;">
                        <t t-set="tax_totals" t-value="o.tax_totals"/>
                        <t t-call="account.document_tax_totals_company_currency_template"/>
                    </div>
                    <div style="clear: both;"/>
                </t>

                <!-- ==================== TÉRMINOS Y CONDICIONES ==================== -->
                <t t-if="o.narration">
                    <div style="font-size: 10px; margin-bottom: 10px; line-height: 1.4;">
                        <strong>Términos y condiciones:</strong>
                        <span t-field="o.narration"/>
                    </div>
                </t>

                <!-- ==================== TOTAL EN LETRAS ==================== -->
                <div style="font-size: 13px; font-weight: bold; margin: 10px 0;">
                    Son: <span t-esc="o.currency_id.amount_to_text(o.amount_total)"/>
                </div>

                <!-- ==================== QR CODE + CAE ==================== -->
                <!-- Campos de l10n_ar_afipws_fe (dependencia directa) -->
                <div style="margin-top: 15px; border-top: 1px solid #000; padding-top: 8px;">
                    <table style="width: 100%;">
                        <tr>
                            <td style="width: 60%; font-size: 10px; vertical-align: top;">
                                <t t-if="o.afip_auth_code">
                                    <strong>CAE:</strong> <span t-field="o.afip_auth_code"/><br/>
                                    <strong>Fecha Vto. CAE:</strong> <span t-field="o.afip_auth_code_due"/>
                                </t>
                            </td>
                            <td style="width: 40%; text-align: right; vertical-align: top;">
                                <t t-if="o.qr_code">
                                    <img t-att-src="image_data_uri(o.qr_code)"
                                         style="width: 130px; height: 130px;"
                                         alt="QR AFIP"/>
                                </t>
                            </td>
                        </tr>
                    </table>
                </div>

            </div>
        </t>
    </template>

</odoo>
